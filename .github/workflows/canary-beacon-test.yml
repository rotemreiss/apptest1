name: Canary beacon test

on:
  workflow_dispatch:
  # pull_request:
  #   branches: [ main ]

jobs:
  run-beacon-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install interactsh-client
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/projectdiscovery/interactsh/releases/latest | grep 'tag_name' | cut -d'"' -f4)
          TEMP_DIR=$(mktemp -d)
          cd "${TEMP_DIR}"
          wget -q "https://github.com/projectdiscovery/interactsh/releases/download/${LATEST_VERSION}/interactsh-client_${LATEST_VERSION#v}_linux_amd64.zip"
          unzip -q interactsh-client_${LATEST_VERSION#v}_linux_amd64.zip
          chmod +x interactsh-client
          echo "${TEMP_DIR}" >> $GITHUB_PATH

      - name: Start interactsh listener
        id: start_interactsh
        env:
          INTERACTSH_TOKEN: ${{ secrets.INTERACTSH_TOKEN }}
          INTERACTSH_HOST: ${{ vars.INTERACTSH_HOST }}
        run: |
          INTERACT_LOG="${RUNNER_TEMP}/interactsh.log"
          INTERACT_PID_FILE="${RUNNER_TEMP}/interactsh.pid"
          PAYLOAD_FILE="interactsh_payload.txt"

          if [ -z "${INTERACTSH_TOKEN}" ]; then
            echo "Missing INTERACTSH_TOKEN secret" >&2
            exit 1
          fi
          if [ -z "${INTERACTSH_HOST}" ]; then
            echo "Missing INTERACTSH_HOST variable" >&2
            exit 1
          fi

          nohup interactsh-client -s "${INTERACTSH_HOST}" -token "${INTERACTSH_TOKEN}" -duc -http-only -v -ps -o "${INTERACT_LOG}" 2>&1 &
          echo $! > "${INTERACT_PID_FILE}"

          echo "Interactsh PID: $(cat "${INTERACT_PID_FILE}")"

          # Wait for the payload file to be created
          timeout 60s bash -c "while [ ! -f '${PAYLOAD_FILE}' ]; do sleep 1; done" || {
            echo "Timeout waiting for interactsh payload file. Log contents:" >&2
            cat "${INTERACT_LOG}" >&2
            exit 124
          }

          # Extract the hostname from the payload file
          HOSTNAME=$(cat "${PAYLOAD_FILE}" | xargs)
          if [ -z "${HOSTNAME}" ]; then
            echo "Failed to read hostname from ${PAYLOAD_FILE}" >&2
            cat "${PAYLOAD_FILE}" >&2
            exit 1
          fi

          {
            echo "INTERACTSH_CANARY_HOST=${HOSTNAME}"
            echo "INTERACT_LOG=${INTERACT_LOG}"
            echo "INTERACT_PID=$(cat "${INTERACT_PID_FILE}")"
          } >> "$GITHUB_ENV"
          echo "interactsh-host=${HOSTNAME}" >> "$GITHUB_OUTPUT"

      - name: Replace CANARYTOKEN_URL with interactsh host
        run: |
          HOST="${INTERACTSH_CANARY_HOST:?Interactsh host missing}"
          mapfile -t files < <(git grep -l 'CANARYTOKEN_URL' || true)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No files contained CANARYTOKEN_URL" >&2
            exit 1
          fi
          for file in "${files[@]}"; do
            sed -i "s|CANARYTOKEN_URL|${HOST}|g" "${file}"
          done
          echo "Updated placeholders in ${#files[@]} files"

      - name: Trigger npm beacons
        run: |
          npm install || true

      - name: Trigger Maven beacons
        run: |
          mvn -B install || true

      - name: Trigger Gradle beacons
        run: |
          if [ -x ./gradlew ]; then
            ./gradlew build || true
          else
            gradle build || true
          fi

      - name: Trigger NuGet beacons
        run: |
          dotnet build dotnet-canary/ || true

      - name: Trigger Docker beacons
        run: |
          docker build . || true

      - name: Collect and validate beacon hits
        run: |
          INTERACT_LOG="${RUNNER_TEMP}/interactsh.log"
          INTERACT_PID_FILE="${RUNNER_TEMP}/interactsh.pid"

          # Give a bit of time for final requests to arrive
          sleep 10

          # Kill the interactsh listener if still running
          if [ -f "${INTERACT_PID_FILE}" ]; then
            INTERACT_PID=$(cat "${INTERACT_PID_FILE}")
            if [ -n "${INTERACT_PID}" ] && kill -0 "${INTERACT_PID}" 2>/dev/null; then
              kill "${INTERACT_PID}" || true
            fi
          fi

          BEACONS=(
            npm_pre_install
            mvn_package
            mvn_post_install
            gradle_package
            gradle_post_install
            nuget_package
            ubuntu-stage-dockerfile
          )

          echo "| Beacon | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"

          missing=()
          for beacon in "${BEACONS[@]}"; do
            if grep -q "${beacon}" "${INTERACT_LOG}" 2>/dev/null; then
              echo "| ${beacon} | ✅ triggered |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| ${beacon} | ❌ missing |" >> "$GITHUB_STEP_SUMMARY"
              missing+=("${beacon}")
            fi
          done

          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing beacons: ${missing[*]}" >&2
            exit 1
          fi

      - name: Upload interactsh logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: interactsh-logs
          path: ${{ runner.temp }}/interactsh.log
          retention-days: 30
